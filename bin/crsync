#!/bin/bash -e

OPTIND=1

fetch_only=0
force=0

while getopts "fF" opt; do
  case "$opt" in
  f)  fetch_only=1
      ;;
  F)  force=1
      ;;
  esac
done

shift $((OPTIND-1))

if [[ "${force}" == "0" ]]; then
  chrome-tree-open
fi

top_dir=`pwd`

# Update depot tools
gclient --version
gclient --version

echo ""
echo "Updating/rebasing Blink..."
cd ${top_dir}/third_party/WebKit
git fetch origin
if [[ "${fetch_only}" == "0" ]]; then
  git rebaseall
  git checkout master
fi

echo ""
echo "Updating/rebasing Chromium..."
cd ${top_dir}
git fetch origin
if [[ "${fetch_only}" == "0" ]]; then
  git rebaseall
  git checkout master
fi

echo ""
echo "Updating/rebasing Leveldb"
cd ${top_dir}/third_party/leveldatabase/src
git fetch origin
if [[ "${fetch_only}" == "0" ]]; then
  git rebaseall
  git checkout master
fi

echo ""
  if [[ "${fetch_only}" == "0" ]]; then
  echo "Syncing all projects..."
  cd ${top_dir}
  gclient sync
fi

# Now delete my gyp state file to force crbuild to regyp
rm -f .GYP_STATE
